name: Issue Labeler

on:
  issues:
    types: [opened, edited]

jobs:
  label-size:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Apply size label from dropdown
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            // Size label mapping from implementation-task dropdown
            const sizeLabels = {
              'small (<1 hour)': 'size:small',
              'medium (1-4 hours)': 'size:medium',
              'large (needs breakdown)': 'size:large'
            };

            // Find size selection in issue body
            // The dropdown renders as "### Size Estimate\n\nsmall (<1 hour)" format
            const sizeMatch = body.match(/### Size Estimate\s*\n\n(small \(<1 hour\)|medium \(1-4 hours\)|large \(needs breakdown\))/i);

            if (sizeMatch) {
              const selectedSize = sizeMatch[1];
              const newLabel = sizeLabels[selectedSize];

              if (newLabel) {
                // Get current labels
                const currentLabels = issue.labels.map(l => l.name);

                // Remove any existing size labels
                const sizeLabelsToRemove = currentLabels.filter(l => l.startsWith('size:'));

                // Only update if label changed
                if (!currentLabels.includes(newLabel) || sizeLabelsToRemove.length > 1) {
                  // Remove old size labels
                  for (const label of sizeLabelsToRemove) {
                    if (label !== newLabel) {
                      await github.rest.issues.removeLabel({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue.number,
                        name: label
                      }).catch(() => {}); // Ignore if label doesn't exist
                    }
                  }

                  // Add new size label
                  if (!currentLabels.includes(newLabel)) {
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      labels: [newLabel]
                    });
                    console.log(`Applied label: ${newLabel}`);
                  }
                }
              }
            }
